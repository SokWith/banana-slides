# === 阶段 1: 前端构建 ===
FROM node:18-alpine AS frontend-builder
WORKDIR /app/frontend
COPY frontend/package*.json ./
RUN npm install --prefer-offline --no-audit --legacy-peer-deps
COPY frontend/ ./
ARG VITE_API_BASE_URL=/api
RUN CI=false npm run build

# === 阶段 2: 后端依赖 ===
FROM python:3.10-slim AS builder-backend
WORKDIR /app
RUN pip install --no-cache-dir pipreqs
COPY backend/ ./backend/
RUN pipreqs ./backend --force && \
    pip install --no-cache-dir -r ./backend/requirements.txt && \
    pip install --no-cache-dir python-pptx google-genai openai flask-sqlalchemy flask-migrate flask-cors werkzeug

# === 阶段 3: 运行阶段 ===
FROM python:3.10-slim
WORKDIR /app

COPY --from=builder-backend /usr/local/lib/python3.10/site-packages /usr/local/lib/python3.10/site-packages
COPY --from=builder-backend /usr/local/bin /usr/local/bin
COPY backend/ .

# 关键：我们将前端 dist 直接重命名为 backend 下的 static 文件夹
RUN rm -rf static && mkdir -p static
COPY --from=frontend-builder /app/frontend/dist/ ./static/

# --- 创建启动脚本 ---
RUN cat <<EOF > hf_runner.py
import os
import sys
from flask import Flask, send_from_directory
from flask_cors import CORS

# 1. 加载应用
sys.path.append(os.getcwd())
try:
    from app import app, db
    print("Backend app loaded.")
except Exception as e:
    print(f"Error: {e}")
    sys.exit(1)

CORS(app)

# 2. 【核心点】强制配置 Flask 原生静态分发
# 把 static 文件夹作为根路径分发
app.static_folder = os.path.abspath('static')
app.static_url_path = '/' 

# 3. 拦截所有不匹配的路由，返回 index.html (支持 SPA)
@app.errorhandler(404)
def handle_404(e):
    # 如果是 API 报错，返回 JSON
    if request.path.startswith('/api'):
        return {"error": "Not found"}, 404
    # 否则返回前端入口
    return send_from_directory(app.static_folder, 'index.html')

# 4. 补齐首页路由（防止被原有逻辑拦截）
@app.route('/')
def hf_index():
    return send_from_directory(app.static_folder, 'index.html')

if __name__ == '__main__':
    with app.app_context():
        try:
            db.create_all()
            print("Database ready.")
        except: pass

    # 打印一下物理路径确保万无一失
    asset_path = os.path.join(app.static_folder, 'assets')
    if os.path.exists(asset_path):
        print(f"Assets dir content: {os.listdir(asset_path)}")

    print("Starting on 7860...")
    app.run(host='0.0.0.0', port=7860, threaded=True)
EOF

RUN chmod -R 777 /app
ENV PORT=7860
EXPOSE 7860

CMD ["python", "hf_runner.py"]
