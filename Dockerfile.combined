# === 阶段 1: 前端构建 ===
FROM node:18-alpine AS frontend-builder
WORKDIR /app/frontend
COPY frontend/package*.json ./
RUN npm install --prefer-offline --no-audit --legacy-peer-deps
COPY frontend/ ./
ARG VITE_API_BASE_URL=/api
RUN CI=false npm run build

# === 阶段 2: 后端依赖 ===
FROM python:3.10-slim AS builder-backend
WORKDIR /app
RUN pip install --no-cache-dir pipreqs
COPY backend/ ./backend/
RUN pipreqs ./backend --force && \
    pip install --no-cache-dir -r ./backend/requirements.txt && \
    pip install --no-cache-dir python-pptx google-genai openai flask-sqlalchemy flask-migrate

# === 阶段 3: 运行阶段 (Hugging Face 专用) ===
FROM python:3.10-slim
WORKDIR /app

# 1. 拷贝环境和源码
COPY --from=builder-backend /usr/local/lib/python3.10/site-packages /usr/local/lib/python3.10/site-packages
COPY --from=builder-backend /usr/local/bin /usr/local/bin
COPY backend/ .

# 2. 拷贝前端静态文件
RUN mkdir -p static
COPY --from=frontend-builder /app/frontend/dist/ ./static/

# 3. 创建入口脚本 (避开转义，使用单一命令写入文件)
# 这个脚本会动态覆盖 app.py 的默认行为
RUN printf "import os\n\
import sys\n\
from flask import send_from_directory\n\
\n\
# 将当前目录加入路径并导入原 app\n\
sys.path.append(os.getcwd())\n\
try:\n\
    from app import app, db\n\
except ImportError:\n\
    from app import app\n\
    db = None\n\
\n\
# 强行覆盖静态文件配置\n\
app.static_folder = 'static'\n\
app.static_url_path = '/'\n\
\n\
# 数据库初始化\n\
with app.app_context():\n\
    if db: \n\
        try: db.create_all()\n\
        except: pass\n\
\n\
# 定义前端托管路由 (它会作为兜底路由)\n\
@app.route('/', defaults={'path': ''})\n\
@app.route('/<path:path>')\n\
def serve_frontend(path):\n\
    full_path = os.path.join(app.static_folder, path)\n\
    if path != '' and os.path.exists(full_path):\n\
        return send_from_directory(app.static_folder, path)\n\
    return send_from_directory(app.static_folder, 'index.html')\n\
\n\
if __name__ == '__main__':\n\
    port = int(os.environ.get('PORT', 7860))\n\
    app.run(host='0.0.0.0', port=port)\n\
" > hf_runner.py

# 4. Hugging Face 权限处理
RUN chmod -R 777 /app

ENV PORT=7860
ENV PYTHONPATH=/app
EXPOSE 7860

# 5. 启动点
CMD ["python", "hf_runner.py"]
