# === 阶段 1: 前端构建 ===
FROM node:18-alpine AS frontend-builder
WORKDIR /app/frontend
COPY frontend/package*.json ./
RUN npm install --prefer-offline --no-audit
COPY frontend/ ./
ARG VITE_API_BASE_URL=/api
RUN CI=false npm run build

# === 阶段 2: 后端依赖扫描与安装 ===
FROM python:3.10-slim AS builder-backend
WORKDIR /app
RUN pip install --no-cache-dir pipreqs
COPY backend/ ./backend/
RUN pipreqs ./backend --force && \
    pip install --no-cache-dir -r ./backend/requirements.txt && \
    pip install --no-cache-dir python-pptx google-genai openai

# === 阶段 3: 运行阶段 ===
FROM python:3.10-slim
WORKDIR /app

# 从阶段 2 拷贝环境
COPY --from=builder-backend /usr/local/lib/python3.10/site-packages /usr/local/lib/python3.10/site-packages
COPY --from=builder-backend /usr/local/bin /usr/local/bin

# 拷贝后端源码
COPY backend/ .

# 拷贝前端产物
RUN mkdir -p static
COPY --from=frontend-builder /app/frontend/dist/ ./static/

# --- 平衡前后端逻辑：使用可靠的脚本写入方式 ---
RUN printf 'import os\n\
from flask import send_from_directory\n\
def apply_patch(app):\n\
    @app.route("/", defaults={"path": ""})\n\
    @app.route("/<path:path>")\n\
    def serve(path):\n\
        if path != "" and os.path.exists(os.path.join(app.static_folder, path)):\n\
            return send_from_directory(app.static_folder, path)\n\
        return send_from_directory(app.static_folder, "index.html")\n\
' > patch_router.py

# 修改 app.py：1. 调整 Flask 初始化；2. 避开原有的根路由；3. 注入新路由
RUN python3 -c ' \
path = "app.py"; \
content = open(path).read(); \
content = content.replace("app = Flask(__name__)", "app = Flask(__name__, static_folder=\"static\", static_url_path=\"/\")"); \
content = content.replace("@app.route(\"/\")", "@app.route(\"/api/info\")"); \
content += "\nfrom patch_router import apply_patch\napply_patch(app)\n"; \
open(path, "w").write(content);'

ENV PORT=5000
ENV PYTHONPATH=/app
EXPOSE 5000

CMD ["python", "app.py"]
