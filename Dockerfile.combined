# === 阶段 1: 前端构建 ===
FROM node:18-alpine AS frontend-builder
WORKDIR /app/frontend
COPY frontend/package*.json ./
RUN npm install --prefer-offline --no-audit
COPY frontend/ ./
ARG VITE_API_BASE_URL=/api
RUN CI=false npm run build

# === 阶段 2: 后端依赖扫描与安装 ===
FROM python:3.10-slim AS builder-backend
WORKDIR /app
RUN pip install --no-cache-dir pipreqs
COPY backend/ ./backend/
RUN pipreqs ./backend --force && \
    pip install --no-cache-dir -r ./backend/requirements.txt && \
    pip install --no-cache-dir python-pptx google-genai openai

# === 阶段 3: 运行阶段 (平衡方案) ===
FROM python:3.10-slim
WORKDIR /app

# 拷贝依赖
COPY --from=builder-backend /usr/local/lib/python3.10/site-packages /usr/local/lib/python3.10/site-packages
COPY --from=builder-backend /usr/local/bin /usr/local/bin

# 拷贝后端源码
COPY backend/ .

# 拷贝前端产物
RUN mkdir -p static
COPY --from=frontend-builder /app/frontend/dist/ ./static/

# --- 核心平衡逻辑：创建一个独立的外壳文件来启动 Flask ---
# 这样做避开了直接修改 app.py 时可能遇到的语法错误或转义问题
RUN echo 'import os\n\
from flask import send_from_directory\n\
from app import app as original_app\n\
\n\
# 重新配置静态文件目录\n\
original_app.static_folder = "static"\n\
original_app.static_url_path = "/"\n\
\n\
@original_app.route("/", defaults={"path": ""})\n\
@original_app.route("/<path:path>")\n\
def serve_frontend(path):\n\
    if path != "" and os.path.exists(os.path.join(original_app.static_folder, path)):\n\
        return send_from_directory(original_app.static_folder, path)\n\
    return send_from_directory(original_app.static_folder, "index.html")\n\
\n\
if __name__ == "__main__":\n\
    port = int(os.environ.get("PORT", 5000))\n\
    original_app.run(host="0.0.0.0", port=port)\n\
' > run_combined.py

ENV PORT=5000
ENV PYTHONPATH=/app
EXPOSE 5000

# 使用我们的新外壳启动
CMD ["python", "run_combined.py"]
