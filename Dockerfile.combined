# === 阶段 1: 前端构建 ===
FROM node:18-alpine AS frontend-builder
WORKDIR /app/frontend
COPY frontend/package*.json ./
RUN npm install --prefer-offline --no-audit --legacy-peer-deps
COPY frontend/ ./
ARG VITE_API_BASE_URL=/api
RUN CI=false npm run build

# === 阶段 2: 后端依赖 ===
FROM python:3.10-slim AS builder-backend
WORKDIR /app
RUN pip install --no-cache-dir pipreqs
COPY backend/ ./backend/
RUN pipreqs ./backend --force && \
    pip install --no-cache-dir -r ./backend/requirements.txt && \
    pip install --no-cache-dir python-pptx google-genai openai flask-sqlalchemy flask-migrate flask-cors werkzeug

# === 阶段 3: 运行阶段 ===
FROM python:3.10-slim
WORKDIR /app

COPY --from=builder-backend /usr/local/lib/python3.10/site-packages /usr/local/lib/python3.10/site-packages
COPY --from=builder-backend /usr/local/bin /usr/local/bin
COPY backend/ .

# 准备静态文件
RUN mkdir -p /app/static
COPY --from=frontend-builder /app/frontend/dist/ /app/static/

# --- 创建增强版启动脚本 ---
RUN cat <<EOF > hf_runner.py
import os
import sys
from flask import Flask, send_from_directory
from flask_cors import CORS

# 1. 加载应用
sys.path.append(os.getcwd())
try:
    from app import app, db
    print("Backend app loaded.")
except Exception as e:
    print(f"Critical Load Error: {e}")
    sys.exit(1)

CORS(app)
# 绝对路径锁定
STATIC_AUTH_DIR = os.path.abspath('static')
app.static_folder = STATIC_AUTH_DIR

# 2. 深度穿透的文件分发函数
def catch_all_optimized(path=''):
    # 确保路径安全
    normalized_path = path.strip("/")
    full_path = os.path.join(STATIC_AUTH_DIR, normalized_path)
    
    # 调试日志：如果还是404，可以在HF日志里看它在找哪里
    # print(f"Request Path: {path} -> Checking: {full_path}")

    # 情况 A: 访问根目录
    if not path or path == '/':
        return send_from_directory(STATIC_AUTH_DIR, 'index.html')

    # 情况 B: 访问物理存在的文件 (assets/xxx.js, logo.png 等)
    if os.path.exists(full_path) and os.path.isfile(full_path):
        return send_from_directory(os.path.dirname(full_path), os.path.basename(full_path))

    # 情况 C: API 请求但文件不存在（交给后端逻辑或报404）
    if path.startswith('api/'):
        return {"error": "API route not found"}, 404

    # 情况 D: 前端路由刷新 (例如 /dashboard)，没有文件后缀的请求统一回向 index.html
    if '.' not in os.path.basename(path):
        return send_from_directory(STATIC_AUTH_DIR, 'index.html')

    return f"Asset not found: {path}", 404

if __name__ == '__main__':
    # 3. 数据库初始化
    with app.app_context():
        try:
            db.create_all()
            print("Database check: OK.")
        except Exception as e:
            print(f"Database Note: {e}")

    # 4. 路由补丁：解决 KeyError 和子目录 404
    app.view_functions['catch_all_optimized'] = catch_all_optimized

    for rule in list(app.url_map.iter_rules()):
        # 统一劫持根路由和幽灵路由
        if rule.rule == '/' or rule.endpoint not in app.view_functions:
            app.view_functions[rule.endpoint] = lambda **kwargs: catch_all_optimized(kwargs.get('path', ''))
        
        # 劫持所有带 path 的静态分发
        elif '<path:path>' in rule.rule:
            app.view_functions[rule.endpoint] = catch_all_optimized

    print("Checking static files structure:")
    for root, dirs, files in os.walk(STATIC_AUTH_DIR):
        for f in files: print(f" - Found: {os.path.join(root, f)}")

    app.run(host='0.0.0.0', port=7860, threaded=True)
EOF

RUN chmod -R 777 /app
ENV PORT=7860
ENV PYTHONPATH=/app
EXPOSE 7860

CMD ["python", "hf_runner.py"]
