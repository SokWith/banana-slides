# === 阶段 1: 前端构建 ===
FROM node:18-alpine AS frontend-builder
WORKDIR /app/frontend
COPY frontend/package*.json ./
RUN npm install --prefer-offline --no-audit
COPY frontend/ ./
ARG VITE_API_BASE_URL=/api
RUN CI=false npm run build

# === 阶段 2: 后端与运行 ===
FROM python:3.10-slim
WORKDIR /app

# 1. 一次性补全所有发现的依赖（包括最新的 python-pptx）
RUN pip install --no-cache-dir \
    flask flask-cors requests python-dotenv pillow tenacity \
    sqlalchemy flask-sqlalchemy flask-migrate flask-marshmallow \
    marshmallow-sqlalchemy google-genai openai python-pptx

# 2. 拷贝后端源码
COPY backend/ .

# 3. 核心修复：修改 app.py 以支持前端托管
# 我们把原有的根路由改为返回静态文件，或者直接删掉它让 Flask 使用默认静态逻辑
RUN sed -i 's/return jsonify({/return app.send_static_file("index.html") #/g' app.py

# 4. 托管前端静态文件
RUN mkdir -p static
COPY --from=frontend-builder /app/frontend/dist/ ./static/

# 5. 运行配置
ENV PORT=5000
ENV PYTHONPATH=/app
EXPOSE 5000

CMD ["python", "app.py"]
