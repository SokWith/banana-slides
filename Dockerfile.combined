# === 阶段 1: 前端构建 ===
FROM node:18-alpine AS frontend-builder
WORKDIR /app/frontend
COPY frontend/package*.json ./
# 使用 --legacy-peer-deps 解决可能存在的插件冲突
RUN npm install --prefer-offline --no-audit --legacy-peer-deps
COPY frontend/ ./
ARG VITE_API_BASE_URL=/api
# CI=false 防止将警告（Warning）视为错误（Error）
RUN CI=false npm run build

# === 阶段 2: 后端依赖扫描与安装 ===
FROM python:3.10-slim AS builder-backend
WORKDIR /app
RUN pip install --no-cache-dir pipreqs
COPY backend/ ./backend/
# 自动扫描依赖并手动补齐关键库
RUN pipreqs ./backend --force && \
    pip install --no-cache-dir -r ./backend/requirements.txt && \
    pip install --no-cache-dir python-pptx google-genai openai flask-sqlalchemy flask-migrate

# === 阶段 3: 最终运行阶段 ===
FROM python:3.10-slim
WORKDIR /app

# 1. 拷贝 Python 环境依赖
COPY --from=builder-backend /usr/local/lib/python3.10/site-packages /usr/local/lib/python3.10/site-packages
COPY --from=builder-backend /usr/local/bin /usr/local/bin

# 2. 拷贝后端源码
COPY backend/ .

# 3. 准备前端静态文件
RUN mkdir -p static
COPY --from=frontend-builder /app/frontend/dist/ ./static/

# 4. 核心：创建平衡前后端的启动脚本
# 该脚本会：
# - 自动在启动前创建数据库表（解决 no such table 报错）
# - 强制 Flask 托管静态文件（解决前端不显示问题）
# - 维持 API 路由优先级
RUN printf 'import os\n\
from flask import send_from_directory\n\
try:\n\
    from app import app, db\n\
except ImportError:\n\
    from app import app\n\
    db = None\n\
\n\
# 初始化数据库（解决 settings 表缺失）\n\
with app.app_context():\n\
    if db:\n\
        try:\n\
            db.create_all()\n\
            print("Database initialized.")\n\
        except Exception as e: print(f"DB Init Warning: {e}")\n\
\n\
# 配置前端托管\n\
app.static_folder = "static"\n\
app.static_url_path = "/"\n\
\n\
# 拦截所有非 API 请求返回前端 index.html\n\
@app.route("/", defaults={"path": ""})\n\
@app.route("/<path:path>")\n\
def serve_frontend(path):\n\
    if path != "" and os.path.exists(os.path.join(app.static_folder, path)):\n\
        return send_from_directory(app.static_folder, path)\n\
    return send_from_directory(app.static_folder, "index.html")\n\
\n\
if __name__ == "__main__":\n\
    app.run(host="0.0.0.0", port=5000)\n\
' > run_final.py

# 5. 运行配置
ENV PORT=5000
ENV PYTHONPATH=/app
EXPOSE 5000

# 启动定制的平衡脚本
CMD ["python", "run_final.py"]
