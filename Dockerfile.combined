# === 阶段 1 & 2 保持不变 ===
FROM node:18-alpine AS frontend-builder
WORKDIR /app/frontend
COPY frontend/package*.json ./
RUN npm install --prefer-offline --no-audit --legacy-peer-deps
COPY frontend/ ./
ARG VITE_API_BASE_URL=/api
RUN CI=false npm run build

FROM python:3.10-slim AS builder-backend
WORKDIR /app
RUN pip install --no-cache-dir pipreqs
COPY backend/ ./backend/
RUN pipreqs ./backend --force && \
    pip install --no-cache-dir -r ./backend/requirements.txt && \
    pip install --no-cache-dir python-pptx google-genai openai flask-sqlalchemy flask-migrate flask-cors

# === 阶段 3: 运行阶段 ===
FROM python:3.10-slim
WORKDIR /app

COPY --from=builder-backend /usr/local/lib/python3.10/site-packages /usr/local/lib/python3.10/site-packages
COPY --from=builder-backend /usr/local/bin /usr/local/bin
COPY backend/ .

# 确保静态目录结构正确
RUN mkdir -p /app/static
COPY --from=frontend-builder /app/frontend/dist/ /app/static/

# --- 核心：创建增强型启动脚本 ---
RUN cat <<EOF > hf_final_runner.py
import os
import sys
import traceback
from flask import Flask, send_from_directory, jsonify
from flask_cors import CORS

# 获取绝对路径
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
STATIC_DIR = os.path.join(BASE_DIR, 'static')

# 确保导入原应用
sys.path.append(BASE_DIR)
try:
    from app import app as original_app, db
except Exception as e:
    print(f"Import Error: {e}")
    from flask import Flask
    original_app = Flask(__name__)
    db = None

app = original_app
CORS(app)

# 强制重置静态配置，使用绝对路径
app.static_folder = STATIC_DIR
app.static_url_path = '/'

# 清理原有根路由
try:
    for rule in list(app.url_map.iter_rules()):
        if rule.rule == '/':
            app.view_functions.pop(rule.endpoint, None)
except:
    pass

@app.route('/', defaults={'path': ''})
@app.route('/<path:path>')
def serve(path):
    try:
        # 调试信息
        print(f"Trying to serve path: {path}")
        
        # 1. 尝试寻找物理文件
        file_path = os.path.join(app.static_folder, path)
        if path != "" and os.path.exists(file_path):
            return send_from_directory(app.static_folder, path)
        
        # 2. 兜底返回 index.html
        index_path = os.path.join(app.static_folder, 'index.html')
        if os.path.exists(index_path):
            return send_from_directory(app.static_folder, 'index.html')
        else:
            return f"Error: index.html not found at {index_path}", 404
            
    except Exception as e:
        print(traceback.format_exc())
        return str(e), 500

if __name__ == '__main__':
    with app.app_context():
        try:
            if db: db.create_all()
            print("Database checked.")
        except: pass
    
    # 开启 debug=False 但打印详细错误
    app.run(host='0.0.0.0', port=7860, threaded=True)
EOF

# 权限加固
RUN chmod -R 777 /app/static
ENV PORT=7860
ENV PYTHONPATH=/app
EXPOSE 7860

CMD ["python", "hf_final_runner.py"]
